# File: docker-compose.yml
services:
  # nginx1:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile-nginx
  #     args:
  #       SERVER_NAME: nginx1
  #   ports:
  #     - "8081:8081"
  #   volumes:
  #     - ./nginx-logs/nginx1:/var/log/nginx
  #   networks:
  #     - mtls-network

  # nginx2:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile-nginx
  #     args:
  #       SERVER_NAME: nginx2
  #   ports:
  #     - "8082:8082"
  #   volumes:
  #     - ./nginx-logs/nginx2:/var/log/nginx
  #   networks:
  #     - mtls-network

  # nginx3:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile-nginx
  #     args:
  #       SERVER_NAME: nginx3
  #   ports:
  #     - "8083:8083"
  #   volumes:
  #     - ./nginx-logs/nginx3:/var/log/nginx
  #   networks:
  #     - mtls-network

  vault:
    build:
      context: .
      dockerfile: Dockerfile-vault
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    volumes:
      - ./vault-config:/vault/config
      - ./vault-data:/vault/data
      - ./metrics_policy.hcl:/vault/config/metrics_policy.hcl 
      - ./vault-logs:/vault/logs
    command: server
    networks:
      - mtls-network
  

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - mtls-network

  node-exporter:
    image: prom/node-exporter
    ports:
      - "9100:9100"
    networks:
      - mtls-network

  uptrace:
    image: uptrace/uptrace:1.7.6
    volumes:
      - ./uptrace-config:/etc/uptrace
    ports:
      - "14317:14317"  # OpenTelemetry gRPC
      - "14318:14318"  # OpenTelemetry HTTP
      - "8080:8080"    # Uptrace UI
    depends_on:
      - postgres
    environment:
      - UPTRACE_POSTGRES_DSN=postgres://uptrace:uptrace_password@postgres:5432/uptrace?sslmode=disable
    networks:
      - mtls-network

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: uptrace
      POSTGRES_USER: uptrace
      POSTGRES_PASSWORD: uptrace_password
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - mtls-network

  clickhouse:
    image: clickhouse/clickhouse-server:head-alpine
    volumes:
      - ./clickhouse-data:/var/lib/clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    networks:
      - mtls-network
  
  fluentbit:
    image: fluent/fluent-bit:3.1.6
    volumes:
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./vault-logs:/vault/logs
      - ./fluent-bit-logs:/fluent-bit/log
    ports:
      - "24224:24224"
    depends_on:
      - vault
      - uptrace
    networks:
      - mtls-network

networks:
  mtls-network:
    driver: bridge